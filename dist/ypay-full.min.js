!function(){"use strict";class Currency{static USD="USD";static NGN="NGN";static XOF="F CFA";static isValid(t){return Object.values(this).includes(t.toUpperCase())}}const t=/^[A-Za-z0-9]{4}-[A-Za-z0-9]{4}$/,e=/^[0-9]{6}$/,a=/^[0-9]{1,}\|[A-Za-z0-9]{48}$/;class Transaction{constructor(t="",e="",a="",n=0,s="en",o={}){this.sender=this.sanitizeData(e),this.token=this.sanitizeData(t),this.otp=a,this.amount=parseFloat(n.toString()),this.language=s,this.paymentHandlers={onSuccess:o.onSuccess||(()=>{}),onFailure:o.onFailure||(()=>{})};const i=this._validate();i&&(this.validationError=i)}_validate(){const n=[];return this.sender?t.test(this.sender)||n.push("Sender card format is invalid."):n.push("Sender card is required."),this.token?a.test(this.token)||n.push("token card format is invalid."):n.push("token is required."),this.otp?e.test(this.otp)||n.push("Payment code format is invalid."):n.push("Payment code is required."),(isNaN(this.amount)||this.amount<=0)&&n.push("Amount must be a positive number."),["en","fr"].includes(this.language.toString().toLowerCase())||n.push("Language is invalid."),n.length>0?new Error(n.join("\n")):null}async exec(){if(this.validationError)throw this.paymentHandlers.onFailure(this.validationError),this.validationError;try{const t=await fetch("https://ypay.ytech-bf.com/api/v1/project/make-payment",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`,"accept-language":this.language},body:JSON.stringify({card_code:this.sender,amount:this.amount,payment_code:this.otp})});if(t.ok){const e=await t.json();return this.paymentHandlers.onSuccess(e),e}const e=(await t.json().catch(()=>({}))).message||t.statusText||"Payment failed";throw new Error(`${t.status}\n${e}`)}catch(t){throw this.paymentHandlers.onFailure(t),t}}isValid(){return!this.validationError}getValidationErrors(){return this.validationError?this.validationError.message:null}sanitizeData(t=""){return""===t||null==t?"":t=(t=(t=(t=String(t)).replace(/\\0/g,"")).trim()).replace(/<[^>]*>/g,"")}}class YPAY{constructor(t,e,a){this.token=t,this.currency=e||Currency.XOF,this.shopName=a||"Undefined";const n=this._validate();if(n&&(this.validationError=n),YPAY.instance)return YPAY.instance;YPAY.instance=this}createTransaction(t,e,a,n,s={}){return new Transaction(this.token,t,e,a,n,s).exec()}static resetInstance(){YPAY.instance=null}_validate(){const t=[];return Currency.isValid(this.currency)||t.push(this.currency+" is not supported yet"),t.length>0?new Error(t.join("\n")):null}}"undefined"!=typeof module&&module.exports&&(module.exports={YPAY:YPAY,Transaction:Transaction,Currency:Currency,cardPattern:t,paymentCodePattern:e,tokenPattern:a}),global.YPAY=YPAY,global.YPAYTransaction=Transaction,global.YPAYCurrency=Currency;class Localization{constructor(){this.current="en",this.languages={en:"en",fr:"fr"},this.translations={en:{card_label:"Card number",card_placeholder:"Enter your card number",otp_label:"Enter OTP",message:'In order to continue the payment process, you must first log in from the <a href="#">YPAY</a> application, then generate a payment OTP with a value of ',no_app:"I do not have the app yet.",download:"Download the App",submit_button_processing:"Processing...",submit_button:"Submit",error_message:"Enter XXXX-XXXX with letters/digits only.",secured_payment:"Encrypted and Secured Payment",successful_transaction:"Your transaction was successfully processed!",failure_transaction:"Your transaction has not been processed!"},fr:{card_label:"Numéro de carte",card_placeholder:"Entrez votre numéro de carte",otp_label:"Entrez le code OTP",message:"Pour continuer le processus de paiement, vous devez d'abord vous connecter depuis l'application <a href=\"#\">YPAY</a>, puis generer un OTP de paiement d'une valeur de ",download:"Télécharger l'application",submit_button_processing:"Traitement en cours...",submit_button:"Valider",no_app:"Je n'ai pas l'application",error_message:"Format XXXX-XXXX avec lettres et chiffres uniquement.",secured_payment:"Paiement crypté et sécurisé",successful_transaction:"Votre transaction a été traitée avec succès!",failure_transaction:"Votre transaction n'a pas pu être traitée!"}}}isValid(t){return Object.values(this.languages).includes(t.toLowerCase())}setLang(t){switch(t){case this.languages.en:this.current="en";break;case this.languages.fr:this.current="fr";break;default:this.current="en"}}tag(t){return this.translations[this.current][t]||t}}class PaymentUI{static instance;constructor(t,e,a,n={},s=!0,o=!0,i,r){return PaymentUI.instance?PaymentUI.instance:(this.logo=r||"",this.language=a||"en",this.shopName=i||"Unknown",this.currency=e||"XOF",this.token=t,this.modal=!1,this.verbose=o,this.showDialogs=this._normalizeShowDialogs(s),this.handlers=n||{onSuccess:t=>{},onFailure:t=>{}},this.overlayElement=null,this.newWindowRef=null,this.alert=null,this.amount=0,this.localization=new Localization,this.localization.setLang(this.language),this._validate(),this.ypay=new YPAY(t,e,i),PaymentUI.instance=this,this)}_normalizeShowDialogs(t){return"boolean"==typeof t?{onSuccess:t,onFailure:t}:"object"==typeof t&&null!==t?{onSuccess:void 0===t.onSuccess||t.onSuccess,onFailure:void 0===t.onFailure||t.onFailure}:{onSuccess:!0,onFailure:!0}}toString(){return`PaymentUI \n        {\n          shopName: "${this.shopName}",\n          currency: "${this.currency}",\n          language: "${this.language}",\n          token: "${this.token?this.token.substring(0,8)+"...":"none"}",\n          amount: ${this.amount},\n          modal: ${this.modal},\n          showDialogs: { onSuccess: ${this.showDialogs.onSuccess}, onFailure: ${this.showDialogs.onFailure} },\n          verbose: ${this.verbose},\n          hasLogo: ${!!this.logo},\n          handlers: ${Object.keys(this.handlers).join(", ")}\n        }`}_validate(){let t=[];if(this.language&&!this.localization.isValid(this.language)&&t.push("Language is not available"),""===this.token&&t.push("Token is required"),t.length>0)throw this.showLogs("Validation errors:",t.join("\n")),new Error(t.join("\n"))}_getTargetDocument(){if(this.overlayElement)return document;if(this.newWindowRef&&!this.newWindowRef.closed)try{if(this.newWindowRef.document)return this.newWindowRef.document}catch(t){this.showLogs("Cannot access popup window document:",t.message)}return document}closePaymentUI(){this.showLogs("Closing payment UI"),this.overlayElement&&(this.overlayElement.remove(),this.overlayElement=null),this.newWindowRef&&!this.newWindowRef.closed&&(this.newWindowRef.close(),this.newWindowRef=null)}customAlertController(t,e,a){import("./alert_controller.js").then(n=>{n.default&&"function"==typeof n.default&&n.default(t,e,a)}).catch(t=>{this.showLogs("Alert controller not available:",t)})}customAlert(t,e){("success"===t?this.showDialogs.onSuccess:this.showDialogs.onFailure)?fetch("./ypay_ui/templates/custom_alert.html").then(t=>t.text()).then(a=>{const n=document.createElement("div");n.className="alert-overlay",n.innerHTML=this.renderTemplate(a),this.alert=n,document.body.appendChild(this.alert),this.customAlertController(document,t,e);const s=this.alert.querySelector(".alert"),o=s.querySelector(".close"),i=s.getElementsByTagName("button")[0],close=()=>{this.alert&&this.alert.parentNode&&(this.alert.parentNode.removeChild(this.alert),this.alert=null);let t=this._getTargetDocument().getElementsByClassName("submit_button")[0];t&&(t.innerHTML=this.localization.tag("submit_button"),t.disabled=!1)};o.addEventListener("click",close),i.addEventListener("click",close)}).catch(t=>{this.showLogs("Failed to load alert template:",t)}):this.showLogs(`Alert (${t}):`,e)}formatAmount(){return"fr"===this.language?`${this.amount} ${this.currency}`:`${this.currency} ${this.amount}`}showModal(){this.showLogs("Opening payment modal"),fetch("./ypay_ui/templates/payment_form.html").then(t=>t.text()).then(t=>{const e=document.createElement("div");e.className="modal_overlay",e.innerHTML=this.renderTemplate(t),this.overlayElement=e,document.body.appendChild(e),setTimeout(()=>{const t=document.querySelector(".close_modal");t&&t.addEventListener("click",()=>{this.closePaymentUI()}),document.querySelector(".modal_overlay")&&document.addEventListener("keydown",t=>{"Escape"===t.key&&this.closePaymentUI()}),this.initializeFormController(document)},0)}).catch(t=>{this.showLogs("Failed to load template:",t)})}openNewTab(){this.showLogs("Opening payment in new tab"),fetch("./ypay_ui/templates/payment_form.html").then(t=>t.text()).then(t=>{const e=window.open("","_blank");if(!e){const t="Popup blocked - please allow popups for this site";throw this.showLogs(t),new Error(t)}this.newWindowRef=e,e.document.write(this.renderTemplate(t)),e.document.close(),e.addEventListener("load",()=>{this.initializeFormController(e.document)}),e.focus()}).catch(t=>{this.showLogs("Failed to open payment tab:",t)})}getTemplateData(){return{language:this.language,logoImg:this.logo?`<img src="${this.logo}" alt="Shop Logo"/>`:"",shopName:this.shopName,amount:this.formatAmount(),texts:{message:this.localization.tag("message"),no_app:this.localization.tag("no_app"),download:this.localization.tag("download"),card_label:this.localization.tag("card_label"),card_placeholder:this.localization.tag("card_placeholder"),card_error:this.localization.tag("error_message"),otp_label:this.localization.tag("otp_label"),submit_button:this.localization.tag("submit_button"),secured_payment:this.localization.tag("secured_payment")}}}renderTemplate(t){const e=this.getTemplateData();return t.replace(/\{\{language\}\}/g,e.language).replace(/\{\{logoImg\}\}/g,e.logoImg).replace(/\{\{closeBtn\}\}/g,this.modal?'<button class="close_modal" type="button">×</button>':"").replace(/\{\{shopName\}\}/g,e.shopName).replace(/\{\{amount\}\}/g,e.amount).replace(/\{\{texts\.message\}\}/g,e.texts.message).replace(/\{\{texts\.no_app\}\}/g,e.texts.no_app).replace(/\{\{texts\.download\}\}/g,e.texts.download).replace(/\{\{texts\.card_label\}\}/g,e.texts.card_label).replace(/\{\{texts\.card_placeholder\}\}/g,e.texts.card_placeholder).replace(/\{\{texts\.card_error\}\}/g,e.texts.card_error).replace(/\{\{texts\.otp_label\}\}/g,e.texts.otp_label).replace(/\{\{texts\.submit_button\}\}/g,e.texts.submit_button).replace(/\{\{texts\.secured_payment\}\}/g,e.texts.secured_payment)}initializeFormController(t){this.showLogs("Initializing form controller"),import("./init_form_controller.js").then(e=>{e.default&&"function"==typeof e.default&&e.default(t)}).catch(t=>{this.showLogs("Form controller not available:",t)});const e=t.getElementById("payment_form");e&&e.addEventListener("submit",t=>{t.preventDefault(),this.triggerPayment()})}async triggerPayment(){this.showLogs("Payment triggered",{amount:this.amount,currency:this.currency});const t=this.newWindowRef?this.newWindowRef.document:document,e=t.querySelector(".submit_button");try{const a=t.getElementById("card_code").value.trim(),n=t.getElementsByClassName("otp_input_item"),s=parseInt([...n].map(t=>t.value).join(""));this.showLogs("Processing payment with card:",a.substring(0,4)+"****"),e&&(e.innerHTML=this.localization.tag("submit_button_processing"));const o=await this.ypay.createTransaction(a,s,this.amount,this.localization.current);this.showLogs("Payment successful:",o),this.customAlert("success",o),this.closePaymentUI(),this.handlers.onSuccess&&this.handlers.onSuccess(o)}catch(t){this.showLogs("Payment error:",t),this.customAlert("failure",t),e&&(e.innerHTML=this.localization.tag("submit_button"),e.style.disabled=!1),this.handlers.onFailure&&this.handlers.onFailure(t)}}renderForm(){this.showLogs("Rendering payment form",{modal:this.modal,amount:this.amount,currency:this.currency}),this.modal?this.showModal():this.openNewTab()}showLogs(...t){this.verbose&&console.log("[PaymentUI]",...t)}}buttonController(),"undefined"!=typeof module&&module.exports&&(module.exports={PaymentUI:PaymentUI,Localization:Localization}),global.PaymentUI=PaymentUI,global.YPAYLocalization=Localization}();
!function(e){"use strict";class Localization{constructor(){this.current="en",this.languages={en:"en",fr:"fr"},this.translations={en:{card_label:"Card number",card_placeholder:"Enter your card number",otp_label:"Enter OTP",message:'In order to continue the payment process, you must first log in from the <a href="#">YPAY</a> application, then generate a payment OTP with a value of ',no_app:"I do not have the app yet.",download:"Download the App",submit_button_processing:"Processing...",submit_button:"Submit",error_message:"Enter XXXX-XXXX with letters/digits only.",secured_payment:"Encrypted and Secured Payment",successful_transaction:"Your transaction was successfully processed!",failure_transaction:"Your transaction has not been processed!"},fr:{card_label:"Numéro de carte",card_placeholder:"Entrez votre numéro de carte",otp_label:"Entrez le code OTP",message:"Pour continuer le processus de paiement, vous devez d'abord vous connecter depuis l'application <a href=\"#\">YPAY</a>, puis generer un OTP de paiement d'une valeur de ",download:"Télécharger l'application",submit_button_processing:"Traitement en cours...",submit_button:"Valider",no_app:"Je n'ai pas l'application",error_message:"Format XXXX-XXXX avec lettres et chiffres uniquement.",secured_payment:"Paiement crypté et sécurisé",successful_transaction:"Votre transaction a été traitée avec succès!",failure_transaction:"Votre transaction n'a pas pu être traitée!"}}}isValid(e){return Object.values(this.languages).includes(e.toLowerCase())}setLang(e){switch(e){case this.languages.en:this.current="en";break;case this.languages.fr:this.current="fr";break;default:this.current="en"}}tag(e){return this.translations[this.current][e]||e}}class PaymentUI{static instance;constructor(e,t,o,a={},s=!0,n=!0,i,r){return PaymentUI.instance?PaymentUI.instance:(this.logo=r||"",this.language=o||"en",this.shopName=i||"Unknown",this.currency=t||"XOF",this.token=e,this.modal=!1,this.verbose=n,this.showDialogs=this._normalizeShowDialogs(s),this.handlers=a||{onSuccess:e=>{},onFailure:e=>{}},this.overlayElement=null,this.newWindowRef=null,this.alert=null,this.amount=0,this.localization=new Localization,this.localization.setLang(this.language),this._validate(),this.ypay=new YPAY(e,t,i),PaymentUI.instance=this,this)}_normalizeShowDialogs(e){return"boolean"==typeof e?{onSuccess:e,onFailure:e}:"object"==typeof e&&null!==e?{onSuccess:void 0===e.onSuccess||e.onSuccess,onFailure:void 0===e.onFailure||e.onFailure}:{onSuccess:!0,onFailure:!0}}toString(){return`PaymentUI \n        {\n          shopName: "${this.shopName}",\n          currency: "${this.currency}",\n          language: "${this.language}",\n          token: "${this.token?this.token.substring(0,8)+"...":"none"}",\n          amount: ${this.amount},\n          modal: ${this.modal},\n          showDialogs: { onSuccess: ${this.showDialogs.onSuccess}, onFailure: ${this.showDialogs.onFailure} },\n          verbose: ${this.verbose},\n          hasLogo: ${!!this.logo},\n          handlers: ${Object.keys(this.handlers).join(", ")}\n        }`}_validate(){let e=[];if(this.language&&!this.localization.isValid(this.language)&&e.push("Language is not available"),""===this.token&&e.push("Token is required"),e.length>0)throw this.showLogs("Validation errors:",e.join("\n")),new Error(e.join("\n"))}_getTargetDocument(){if(this.overlayElement)return document;if(this.newWindowRef&&!this.newWindowRef.closed)try{if(this.newWindowRef.document)return this.newWindowRef.document}catch(e){this.showLogs("Cannot access popup window document:",e.message)}return document}closePaymentUI(){this.showLogs("Closing payment UI"),this.overlayElement&&(this.overlayElement.remove(),this.overlayElement=null),this.newWindowRef&&!this.newWindowRef.closed&&(this.newWindowRef.close(),this.newWindowRef=null)}customAlertController(e,t,o){import("./alert_controller.js").then(a=>{a.default&&"function"==typeof a.default&&a.default(e,t,o)}).catch(e=>{this.showLogs("Alert controller not available:",e)})}customAlert(e,t){("success"===e?this.showDialogs.onSuccess:this.showDialogs.onFailure)?fetch("./ypay_ui/templates/custom_alert.html").then(e=>e.text()).then(o=>{const a=document.createElement("div");a.className="alert-overlay",a.innerHTML=this.renderTemplate(o),this.alert=a,document.body.appendChild(this.alert),this.customAlertController(document,e,t);const s=this.alert.querySelector(".alert"),n=s.querySelector(".close"),i=s.getElementsByTagName("button")[0],close=()=>{this.alert&&this.alert.parentNode&&(this.alert.parentNode.removeChild(this.alert),this.alert=null);let e=this._getTargetDocument().getElementsByClassName("submit_button")[0];e&&(e.innerHTML=this.localization.tag("submit_button"),e.disabled=!1)};n.addEventListener("click",close),i.addEventListener("click",close)}).catch(e=>{this.showLogs("Failed to load alert template:",e)}):this.showLogs(`Alert (${e}):`,t)}formatAmount(){return"fr"===this.language?`${this.amount} ${this.currency}`:`${this.currency} ${this.amount}`}showModal(){this.showLogs("Opening payment modal"),fetch("./ypay_ui/templates/payment_form.html").then(e=>e.text()).then(e=>{const t=document.createElement("div");t.className="modal_overlay",t.innerHTML=this.renderTemplate(e),this.overlayElement=t,document.body.appendChild(t),setTimeout(()=>{const e=document.querySelector(".close_modal");e&&e.addEventListener("click",()=>{this.closePaymentUI()}),document.querySelector(".modal_overlay")&&document.addEventListener("keydown",e=>{"Escape"===e.key&&this.closePaymentUI()}),this.initializeFormController(document)},0)}).catch(e=>{this.showLogs("Failed to load template:",e)})}openNewTab(){this.showLogs("Opening payment in new tab"),fetch("./ypay_ui/templates/payment_form.html").then(e=>e.text()).then(e=>{const t=window.open("","_blank");if(!t){const e="Popup blocked - please allow popups for this site";throw this.showLogs(e),new Error(e)}this.newWindowRef=t,t.document.write(this.renderTemplate(e)),t.document.close(),t.addEventListener("load",()=>{this.initializeFormController(t.document)}),t.focus()}).catch(e=>{this.showLogs("Failed to open payment tab:",e)})}getTemplateData(){return{language:this.language,logoImg:this.logo?`<img src="${this.logo}" alt="Shop Logo"/>`:"",shopName:this.shopName,amount:this.formatAmount(),texts:{message:this.localization.tag("message"),no_app:this.localization.tag("no_app"),download:this.localization.tag("download"),card_label:this.localization.tag("card_label"),card_placeholder:this.localization.tag("card_placeholder"),card_error:this.localization.tag("error_message"),otp_label:this.localization.tag("otp_label"),submit_button:this.localization.tag("submit_button"),secured_payment:this.localization.tag("secured_payment")}}}renderTemplate(e){const t=this.getTemplateData();return e.replace(/\{\{language\}\}/g,t.language).replace(/\{\{logoImg\}\}/g,t.logoImg).replace(/\{\{closeBtn\}\}/g,this.modal?'<button class="close_modal" type="button">×</button>':"").replace(/\{\{shopName\}\}/g,t.shopName).replace(/\{\{amount\}\}/g,t.amount).replace(/\{\{texts\.message\}\}/g,t.texts.message).replace(/\{\{texts\.no_app\}\}/g,t.texts.no_app).replace(/\{\{texts\.download\}\}/g,t.texts.download).replace(/\{\{texts\.card_label\}\}/g,t.texts.card_label).replace(/\{\{texts\.card_placeholder\}\}/g,t.texts.card_placeholder).replace(/\{\{texts\.card_error\}\}/g,t.texts.card_error).replace(/\{\{texts\.otp_label\}\}/g,t.texts.otp_label).replace(/\{\{texts\.submit_button\}\}/g,t.texts.submit_button).replace(/\{\{texts\.secured_payment\}\}/g,t.texts.secured_payment)}initializeFormController(e){this.showLogs("Initializing form controller"),import("./init_form_controller.js").then(t=>{t.default&&"function"==typeof t.default&&t.default(e)}).catch(e=>{this.showLogs("Form controller not available:",e)});const t=e.getElementById("payment_form");t&&t.addEventListener("submit",e=>{e.preventDefault(),this.triggerPayment()})}async triggerPayment(){this.showLogs("Payment triggered",{amount:this.amount,currency:this.currency});const e=this.newWindowRef?this.newWindowRef.document:document,t=e.querySelector(".submit_button");try{const o=e.getElementById("card_code").value.trim(),a=e.getElementsByClassName("otp_input_item"),s=parseInt([...a].map(e=>e.value).join(""));this.showLogs("Processing payment with card:",o.substring(0,4)+"****"),t&&(t.innerHTML=this.localization.tag("submit_button_processing"));const n=await this.ypay.createTransaction(o,s,this.amount,this.localization.current);this.showLogs("Payment successful:",n),this.customAlert("success",n),this.closePaymentUI(),this.handlers.onSuccess&&this.handlers.onSuccess(n)}catch(e){this.showLogs("Payment error:",e),this.customAlert("failure",e),t&&(t.innerHTML=this.localization.tag("submit_button"),t.style.disabled=!1),this.handlers.onFailure&&this.handlers.onFailure(e)}}renderForm(){this.showLogs("Rendering payment form",{modal:this.modal,amount:this.amount,currency:this.currency}),this.modal?this.showModal():this.openNewTab()}showLogs(...e){this.verbose&&console.log("[PaymentUI]",...e)}}buttonController(),"undefined"!=typeof module&&module.exports&&(module.exports={PaymentUI:PaymentUI,Localization:Localization}),e.PaymentUI=PaymentUI,e.YPAYLocalization=Localization}("undefined"!=typeof window?window:this);